name: Continuous Training Pipeline

# ==============================================================================
# 1. TRIGGERS
# ==============================================================================
on:
  # Trigger A: Code Changes (The "Developer" Loop)
  push:
    branches: [main]
  pull_request:
    branches: [main]

  # Trigger B: Data Changes (The "Airflow" Loop)
  repository_dispatch:
    types: [trigger-training]

  # NEW: Add Inputs for Manual Trigger
  workflow_dispatch:
    inputs:
      ec2_instance_type:
        description: 'AWS EC2 Instance Type'
        required: true
        default: 't3.micro' # Default to Free Tier safe option
        type: choice
        options:
          - t3.micro    # Free Tier (1GB RAM) - Good for debugging
          - t3.medium   # Paid (~$0.04/hr) - Good for small training
          - g4dn.xlarge # GPU (~$0.50/hr) - Real Deep Learning

jobs:
  # ==============================================================================
  # JOB 1: CI GATEKEEPER (Runs on GitHub Cloud)
  # Goal: Catch bugs cheaply before provisioning expensive EC2 infrastructure.
  # ==============================================================================
  run-tests:
    name: "1. Unit Tests (CI)"
    runs-on: ubuntu-latest # <--- Standard GitHub Runner (Free tier)
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # 1. Build the Image
      # We tag it 'mlops-image' so we can refer to it in the next step
      - name: Build Docker Image
        run: docker build -t mlops-image .

      # 2. Run Tests inside Container
      # --rm: Clean up container after run
      # python -m pytest: Runs pytest as a module (fixes path issues automatically)
      - name: Run Pytest in Docker
        run: |
          docker run --rm \
            -e MLFLOW_TRACKING_URI="file:///tmp/mlruns" \
            mlops-image \
            python -m pytest tests/

  